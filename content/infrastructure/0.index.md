# Infrastructure

## Introduction

The purpose of these documents is to provide an overview of the infrastructure used to operate the Mastodon server, [vmst.io](https://vmst.io).
It should explain how the various services interact and how "the magic" happens when our users open the Mastodon app on their phone or enter our address into their web browser.

::alert{type="warning"}
Unfortunately, it's not really magic, but rather a series of databases and services from various open-source vendors running in a number of different best-in-class public cloud providers.
::

It should also help provide some assurance to our current and potential members that care has been taken in architecting and operating this Mastodon instance.

## Architecture Goals

::list{type="success"}
- Provide better than 99.9% availability each month for our users.
- All critical components should be easily recoverable in the event of failure.
- Be easily scalable, both vertically and horizontally.
- Provide a highly performant experience for our users.
- Don't operate what we're not best suited to operating.
- Automate as much as possible for upgrades to enable the fastest time to implementation.
- Maintain a stable endpoint on the [ActivityPub](https://activitypub.rocks) network.
::

## Layout

![Server Layout](/vmstio-simple.png)

## Core Services

[DigitalOcean](https://www.digitalocean.com) is our primary hosting provider.
We have workloads and data hosted in the TOR1, NYC3, and SFO3 data centers.
Toronto is the home of our primary computing workloads, while New York is used for object storage hosting of the media CDN and documentation site.
San Francisco houses regular backups while an additional replicated copy is located in Kansas City.

### Service Providers

This list represents the cloud provider dependencies to which vmst.io has a direct relationship.
If any of these providers have issues, it may create issues for vmst.io services.
Some of these services are paid for, while others are free to use.

| Vendor        | Service                                                                                                                                                                  |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| DigitalOcean  | Managed PostgreSQL, Managed Kubernetes, Managed OpenSearch, Object Storage, Content Delivery Network (CDN), Load Balancer, Internal Container Registery, and Nameservers |
| AWS           | Simple Email Service                                                                                                                                                     |
| BetterUptime  | Status Monitoring                                                                                                                                                        |
| DNSimple      | Domain Registrar                                                                                                                                                         |
| Let's Encrypt | SSL Certificates                                                                                                                                                         |
| GitHub        | Configuration/Settings, Public Container Registry                                                                                                                        |
| Docker Hub    | Public Container Registry                                                                                                                                                |
| hCaptcha      | Bot Detection                                                                                                                                                            |
| Apivoid       | IP Information                                                                                                                                                           |
| Grafana       | Logs & Metrics Storage                                                                                                                                                   |

Other vendors or open-source projects that we consume or utilize but do not have an ongoing external API or system connection to are not included in this list.
For example, rclone is used to back up our platform, but it is integrated into a custom container image that is built and deployed.
The availability of the application on its download site is not mandatory for the operational readiness of vmst.io.

### Compute Resources

#### Virtual Machines

We use an all-virtual architecture using DigitalOcean "Droplets" as the compute backend for all our hosted services and databases.

#### Kubernetes

We use the DigitalOcean managed Kubernetes service.

Virtual machines are provisioned automatically by the control plane to be consumed as Kubernetes nodes.
There are multiple nodes with 4 vCPUs and 8 GB of memory each.
The total number of nodes can be scaled up or down based on overall demand.

All of the required Mastodon components are run in Kubernetes deployments, which create pods.
Each pod is a Docker container running a given service (Puma, Sidekiq, etc.)

### Required Components

The following reflect the required software components to have a functional deployment of Mastodon:

#### Mastodon

What users perceive as "Mastodon" is a [Ruby on Rails](https://rubyonrails.org) application with a [React](https://react.dev) front end, served by [Puma](https://puma.io).
This provides the Mastodon API, web user interface, as well as ActivityPub federation.

The Streaming API is a separate [Node.js](https://nodejs.org/en/) application which provides a background WebSockets connection between your browser session and the Mastodon server to provide real-time "streaming" updates as new posts are loaded to your timeline.

#### [Sidekiq →](/infrastructure/sidekiq)

#### PostgreSQL

[PostgreSQL](https://www.postgresql.org), often referred to as Postgres, is an open-source relational database management system.
In Mastodon, it is used as the primary database to store and manage various types of data required for the functioning of the platform.
PostgreSQL plays a crucial role in Mastodon's architecture, providing persistence, data integrity, and efficient querying capabilities.

We use the DigitalOcean managed PostgresSQL database service, which delivers a highly available database backend.
Updates and maintenance are performed by DigitalOcean, independent of our administration efforts.

We have one database server ([Majel](https://memory-alpha.fandom.com/wiki/Majel_Barrett_Roddenberry)) with 4 vCPU and 16GB of memory.
We use PostgreSQL 16.x.

DigitalOcean Droplet "T-Shirt" sizes for databases are determined by vCPU, memory, disk size, and connections to the database.
The connection count limits are based on sizing best practices for PostgreSQL, with a few held in reserve for their use to manage the service.

DigitalOcean has an integrated "Connection Pool" feature of their platform, which, in practice, puts the [PgBouncer](https://www.pgbouncer.org) utility in front of the database.
This acts as a reverse proxy / load balancer for the database, to ensure that connections to the database by Mastodon cannot stay open and consume resources longer than needed.

There are a [few options for pooling modes](https://docs.digitalocean.com/products/databases/postgresql/how-to/manage-connection-pools/#pooling-modes) with DigitalOcean, but the default _Transaction Mode_ is the required option for Mastodon.

#### Redis

[Redis](https://redis.io) is an open-source, in-memory data structure store that is used as a database, cache, and message broker.
In Mastodon, Redis is used for various purposes to improve the performance, scalability, and reliability of the platform.

Starting in Mastodon 4.4, Redis folks (such as [Valkey](https://valkey.io)) or alternatives that implement the Redis API are supported for use.

We use the [Dragonfly](https://www.dragonflydb.io) controlled by their Kubernetes Operator split into three databases.

- Mastodon
- Sidekiq
- Cache

All in a high-availibility configuration with regular backups.

#### Ingress

The idea of "ingress" covers the routing of inbound HTTP requests.
We use DigitalOcean managed load balancer objects to distribute user traffic across our frontend reverse proxies.

We use [Nginx](https://www.nginx.com) as our reverse proxy software, running in our Kubernetes environment,  in the form of the [Ingress Nginx Controller](https://kubernetes.github.io/ingress-nginx/).

![Reverse Proxy Diagram](/reverse-proxy.png)

Our Nginx reverse proxies provide TLS/SSL termination.

### Additional Components

Most Mastodon deployments leverage one or more additional components to provide additional functionality.

Some of them include:

#### [Elasticsearch →](/about/search)

#### [Translation API →](/about/translation)

#### [Object Storage →](/infrastructure/object-storage)

Object storage is a scalable and cost-effective storage solution that is used in Mastodon to store and manage large volumes of unstructured data, such as media files (images, videos, and audio) and static assets.
In Mastodon, object storage plays a crucial role in efficiently handling and serving user-uploaded media content.

We use the DigitalOcean Spaces service, which is an S3-compatible object storage provider and includes a content delivery network (CDN) to distribute attached media to multiple points, reducing access latency for users and federated servers.

Our Spaces is in the DigitalOcean NYC3 data center, which is separate from the rest of the workloads which exist in the TOR1 (Toronto) data center.

#### SMTP Relay

All email notifications associated with the vmst.io Mastodon server should come from: `no-reply@vmst.io`.

- We use [Amazon Simple Email Service](https://aws.amazon.com/ses/) as our managed SMTP service, used for sending new user sign-up verifications, and other account notifications.
- We leverage industry technologies like `SPF` and `DKIM` to help verify we are the only ones sending you emails.
- We use **[Fastmail](https://fastmail.com)** for receiving and sending non-automated messages in the `@vmst.io` domain.

When you sign up for an account, and you provide us with an email address, we promise to only contact you there regarding your Mastodon account.
For more details, refer to our [Privacy Policy](https://vmst.io/privacy-policy)
